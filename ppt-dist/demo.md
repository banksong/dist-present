title: 银行分布式架构实施, 踏出第一步
speaker: 谭建斌
url: https://github.com/banksong
transition: slide3
files: /js/demo.js,/css/demo.css,/js/zoom.js
theme: light
usemathjax: yes

[slide style="background-image:url('/back.jpg')"]
# 踏出银行分布式架构实施的第一步
## 主讲：谭建斌
<small style="vertical-align:middle;display:inline-block"><iframe src="http://ghbtns.com/github-btn.html?user=banksong&repo=dist-present&type=follow&count=false" allowtransparency="true" frameborder="0" scrolling="0" width="170" height="20" style="width:170px;height:20px;  background-color: transparent;"></iframe></small>
[note]各位好，高兴今天有机会和普元的领导和技术大牛分享这个主题，在银行实施分布式架构，可以说在今天讲求效率和价值的年代，互联网已经用实际行动证明了技术不断更新迭代是各行各业的未来，而分布式架构，这一技术，这一套技术吧，也在实践中证明它的可行。但是对于金融银行，对系统有高标准要求，实施分布式会有多大的裨益，又需要小心什么坑呢。[/note]
[slide style="background-image:url('/back.jpg')"]
[note]在过去年里，为了保证数据一致性，安全性，高可用，不惜重金彩用了像ibm，mainframe，这样的庞大的基础设备，对于应用程序来说，它们就是一头大象一般的数据库，也甭管里面的怎么弄，反正往里面塞数据，出了问题，找DBA,找ibm，当然最好不要出问题，事实上待会我们介绍中，会提到无论哪个大牛公司的系统，都不可能同时满足所谓的一致性，高可用，但是无疑这是我们要解决的
对于业务，新时代，特别对咱们金融银行要更高的要求，快速支付，小额的，但是量很大，要求秒级别的做完支付，结算，对账，不再有过去的非工作时间这一说了,对于我们的it系统，任何时间都要保证可用，怎么做到呢，
对于日常运维，系统更新，在银行系统里面要保证一切准确无误，出一个更新，真的不简单，好几页的4a纸的发布指南runbook，几十号人围一天，大阵仗，以至于更新速度慢，更不上市场的需要，而且运维成本高昂，人力物力。怎么办呢[/note]
## 永恒的痛点
----
* 数据日益膨胀，机器的最大峰值交易处理压力巨大 {:&.rollIn}
* 业务需求提升，要求系统高可用，提供无间断服务
* 运维管理繁琐，自动化水平落后，维护成本高昂



[slide style="background-image:url('/back.jpg')"]
# *解决痛点的必然，向分布式架构转型*
----
CAP 理论
----
{:&.bounceIn}
<ul>
<li>一致性（Consistency）</li>
<li>可用性（Avaliablity)</li>
<li>分区容错性（Partition tolerance）</li>
</ul>
[note]任何一个系统都无法同时满足以上的三个要求，比如说最近亚马逊的s3和google的staner，它们也是在满足了一致性和分区容错性的情况下，极大的提高可用型，可能到99.99，但也是无法100满足的，所谓的一致性，集群里面的每个节点，对一个变量的值应该是一样的，不能冲突，可用性，任何一个节点down机，整个集群依然可用继续提供客户端服务，分区容错性，现在的节点，服务器都分布在不同的地区，甚至是不同国家，如果现在比如银行要提供国际化服务，有些节点是分布在中国，有些在美国，它们之间通过万兆网络同步，美国和中国之间的网络中断了，虽然各自地区的节点是好的，这个时候集群就分区了，但是它们依然可以向各自地区服务，这个时候的方案，就要分情况，对于数据一致性要求高的，可能就放弃高可用，只有一边地区提供服务，但对于数据一致性不高，或者说可以容忍短时间内一致性不高的服务，比如一些对仗邮件服务，一般来说是一些无状态服务，两个分区可以继续不中断提供服务。[/note]
[slide]
<p>简单的主从架构：一致性强，可用性差</p>
<p>
<img src="/img/master.png" alt="占位符" align="bottom">
</p>
[note]过去广泛使用的主从架构，写集中一个节点，这样数据一致性是毋庸置疑的好，然后配置多个slave节点做热备和读操作，缓解主节点的压力，每次主节点写入，slave节点同步并返回同步成功，这时候主节点返回结果给客户端，一旦其中一个节点down机失联，集群不可用，即使使用多数派，只要多数节点还活着，就继续可用，但是集群里面的其他几点就要补这个坑，切换和恢复不能秒级。更何况如果down掉是主服务器。既然高可用差，就加多几个节点呗[/note]

[slide style="background-image:url('/back.jpg')"]
[note]但问题又来了，银行需要高度的一致性，不要主从，不是一个机子说了算，那一致性如何说起呢,我们可以重点说一下一致性[/note]
## 一致性算法
----
* 弱一致性算法：最终一致性算法，并不能保证每个节点读写立刻同步，但最终能同步。比如DNS系统。 {:&.rollIn}
* 强一致性算法：对数据正确性要求高的金融系统，这是必然的选择。
* Raft算法：在Raft中，任何时候集群里的任意一个节点均可以作为主节点。Leader: 处理所有客户端请求，如写操作，集群里只有一个Leader;Follower: slave节点，被动接受同步;Candidate: 当集群里的leader不可用，而作为下一任leader的候选人。


[slide style="background-image:url('/back.jpg')"]
## Raft算法动态演示
<iframe data-src="http://thesecretlivesofdata.com/raft/" align="center"></iframe>
<!-- [note]增加多几个节点，现在三个节点，其中一个是leader主节点，[/note] -->


[slide style="background-image:url('/back.jpg')"]
### 分布式架构本质：高智能，自动化集群

---
| 传统主从架构 | 分布式架构 
:-------|:------:|-------:|--------
硬件成本 |高 |低(x86) 
扩展难易 | 难 | 易 
日常运营 | 难 | 易 
更新迭代 | 难 | 易
可用性   | 低 | 高
一致性   | 高 | 强一致性
[note]之前互联网提出了一个倡导去ioc，去掉ibm，oracle，emc。取而代之的是开源，便宜的x86和分布式架构。
分布式架构设计的核心理念是“并行拆分与横向扩展”，系统各部分松耦合并行运行。
随着容器和虚拟化技术成熟，自动部署，节点的版本控制，节点的心跳监控，这些已经让运营人员能很轻松的应付日常运营，相比集中式的大机器维护，检测步骤繁琐，而且有些核心机制也不开放。
更新迭代也是一样，受制于主机节点的架构，迭代缓慢
一致性，在不断提高，在业界上还有这样的说法，集中主机所谓的一致性其实也是很脆弱，要么不down，一旦down掉，影响是很大，抢成本很高，分布式虽然不能100%保证每一刻都是数据一致，但是通过划分业务，按照cap理论，对一致性高的业务，比如可以降低一点可用性或者分区容错性，满足一致性，对于一致性要求不高的业务，可以采取最终一致性的做法，保持高可用。[/note]

[slide style="background-image:url('/back.jpg')"]

## 银行业务，有选择，有步骤地实施分布式架构
----
* 对于柜台业务、大客户管理等业务量相对稳定的内容，则重点基于集中式架构持续优化提升。

* 对于客户增值服务、历史明细、现金管理，小额支付、投资理财等业务更新快，高可用要求高的服务则采用分布式架构。
[slide style="background-image:url('/back.jpg')"]
## 交流时间，谢谢！
